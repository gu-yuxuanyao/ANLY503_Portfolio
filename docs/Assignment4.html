<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Yuxuan Yao" />


<title>Assignment 4</title>

<script src="site_libs/header-attrs-2.5/header-attrs.js"></script>
<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/anchor-sections-1.0/anchor-sections.css" rel="stylesheet" />
<script src="site_libs/anchor-sections-1.0/anchor-sections.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="styles.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Anly-503 Portfolio</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Introduction</a>
</li>
<li>
  <a href="project.html">Final Project</a>
</li>
<li>
  <a href="Assignment1.html">Assignment 1 Conceptual Visualization</a>
</li>
<li>
  <a href="Assignment2.html">Assignment 2 Suggestion</a>
</li>
<li>
  <a href="Assignment3.html">Assignment 3 Hand-draw</a>
</li>
<li>
  <a href="Assignment4.html">Assignment 4 Bank Processing</a>
</li>
<li>
  <a href="Assignment5.html">Assignment 5 Bank Analysis</a>
</li>
<li>
  <a href="geospatial.html">Assignment 6 Geospatial</a>
</li>
<li>
  <a href="network.html">Assignment 7 Network</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Assignment 4</h1>
<h4 class="author">Yuxuan Yao</h4>
<h4 class="date">2020/12/6</h4>

</div>


<div id="loan-r" class="section level1">
<h1>loan (R)</h1>
<pre class="r"><code># import packages
library(dplyr)</code></pre>
<pre><code>## 
## Attaching package: &#39;dplyr&#39;</code></pre>
<pre><code>## The following objects are masked from &#39;package:stats&#39;:
## 
##     filter, lag</code></pre>
<pre><code>## The following objects are masked from &#39;package:base&#39;:
## 
##     intersect, setdiff, setequal, union</code></pre>
<pre class="r"><code>library(tidyr)
library(tidyverse)</code></pre>
<pre><code>## -- Attaching packages --------------------------------- tidyverse 1.3.0 --</code></pre>
<pre><code>## √ ggplot2 3.3.2     √ purrr   0.3.4
## √ tibble  3.0.3     √ stringr 1.4.0
## √ readr   1.3.1     √ forcats 0.5.0</code></pre>
<pre><code>## -- Conflicts ------------------------------------ tidyverse_conflicts() --
## x dplyr::filter() masks stats::filter()
## x dplyr::lag()    masks stats::lag()</code></pre>
<pre class="r"><code>library(stringr)
library(plyr)</code></pre>
<pre><code>## ------------------------------------------------------------------------------</code></pre>
<pre><code>## You have loaded plyr after dplyr - this is likely to cause problems.
## If you need functions from both plyr and dplyr, please load plyr first, then dplyr:
## library(plyr); library(dplyr)</code></pre>
<pre><code>## ------------------------------------------------------------------------------</code></pre>
<pre><code>## 
## Attaching package: &#39;plyr&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:purrr&#39;:
## 
##     compact</code></pre>
<pre><code>## The following objects are masked from &#39;package:dplyr&#39;:
## 
##     arrange, count, desc, failwith, id, mutate, rename, summarise,
##     summarize</code></pre>
<pre class="r"><code># read data
loans &lt;-read.csv(&#39;data/loans.csv&#39;)

# process 24_B ... information
# create 2 lists ready for temp list split
term = c()
status = c()

# check every unit whether X is in temp list or not
for (row in 1: nrow(loans)){
  for (col in 6:ncol(loans)){
    if (loans[row,col] == &#39;X&#39;){
      # append certain characters to lists
      # first 2 characters are term
      term = c(term, as.integer(substring(colnames(loans)[col], 2, 3)))
      # last character is status
      status = c(status, substring(colnames(loans)[col], 5, 5))
      break
    }
  }
}

# create 2 new columns in loans
loans$term = term
loans$status =status

# drop 24_B
loans &lt;- loans[c(1:5, 26:27)]

# view data
head(loans)</code></pre>
<pre><code>##     id account_id       date amount payments term status
## 1 4959          2 1994-01-05  80952     3373   24      A
## 2 4961         19 1996-04-29  30276     2523   12      B
## 3 4962         25 1997-12-08  30276     2523   12      A
## 4 4967         37 1998-10-14 318480     5308   60      D
## 5 4968         38 1998-04-19 110736     2307   48      C
## 6 4973         67 1996-05-02 165960     6915   24      A</code></pre>
<pre class="r"><code># save to csv
write_csv(loans,&quot;loans_r.csv&quot;)</code></pre>
</div>
<div id="loan-python" class="section level1">
<h1>loan (Python)</h1>
<pre class="python"><code>import pandas as pd

# load data
loans = pd.read_csv(&quot;./data/loans.csv&quot;)
print(loans.head())

# process 24_B ... information
# col names</code></pre>
<pre><code>##      id  account_id        date  amount  payments  ... 36_A 36_B 60_B 12_D 60_A
## 0  4959           2  1994-01-05   80952      3373  ...    -    -    -    -    -
## 1  4961          19  1996-04-29   30276      2523  ...    -    -    -    -    -
## 2  4962          25  1997-12-08   30276      2523  ...    -    -    -    -    -
## 3  4967          37  1998-10-14  318480      5308  ...    -    -    -    -    -
## 4  4968          38  1998-04-19  110736      2307  ...    -    -    -    -    -
## 
## [5 rows x 25 columns]</code></pre>
<pre class="python"><code>temp = list(loans.columns)[5:]

# create 2 lists ready for temp list split
term = []
status = []

# check every unit whether X is in temp list or not
for index, row in loans.iterrows():
    for col in temp:
        if row[col] == &#39;X&#39;:
            # first 2 characters are term
            term.append(int(col[:2]))
            # last character is status
            status.append(col[-1])
            break

# create 2 new columns in loans
loans[&#39;term&#39;] = term
loans[&#39;status&#39;] = status

# drop 24_B... columns
loans = loans.drop(temp, axis=1)

# view data
print(loans.head())

# save data</code></pre>
<pre><code>##      id  account_id        date  amount  payments  term status
## 0  4959           2  1994-01-05   80952      3373    24      A
## 1  4961          19  1996-04-29   30276      2523    12      B
## 2  4962          25  1997-12-08   30276      2523    12      A
## 3  4967          37  1998-10-14  318480      5308    60      D
## 4  4968          38  1998-04-19  110736      2307    48      C</code></pre>
<pre class="python"><code>loans.to_csv(&#39;loans_py.csv&#39;, index=None)</code></pre>
</div>
<div id="district-r" class="section level1">
<h1>district (R)</h1>
<pre class="r"><code># read data
district &lt;- read.csv(&#39;data/districts.csv&#39;)

# remove &#39;[&#39;, &#39;]&#39; and ready to split them by &#39;,&#39;
district = district %&gt;% mutate(municipality_info = str_replace_all(municipality_info,&quot;\\*|\\[|\\]&quot;, &quot;&quot;))
district = district %&gt;% mutate(unemployment_rate = str_replace_all(unemployment_rate,&quot;\\*|\\[|\\]&quot;, &quot;&quot;))
district = district %&gt;% mutate(commited_crimes = str_replace_all(commited_crimes,&quot;\\*|\\[|\\]&quot;, &quot;&quot;))

# split these columns content by &#39;,&#39;
district[,c(&#39;municipality_0&#39;,&#39;municipality_500&#39;,&#39;municipality_2000&#39;,&#39;municipality_10000&#39;)] &lt;- as.integer(str_split_fixed(district$municipality_info, &quot;,&quot;, 4))
district[,c(&#39;unemployment_rate_95&#39;,&#39;unemployment_rate_96&#39;)] &lt;- as.double(str_split_fixed(district$unemployment_rate, &quot;,&quot;, 2))</code></pre>
<pre><code>## Warning: 强制改变过程中产生了NA</code></pre>
<pre class="r"><code>district[,c(&#39;commited_crimes_95&#39;,&#39;commited_crimes_96&#39;)] &lt;- as.double(str_split_fixed(district$commited_crimes, &quot;,&quot;, 2))</code></pre>
<pre><code>## Warning: 强制改变过程中产生了NA</code></pre>
<pre class="r"><code># drop original colunms
district &lt;- district[c(1:8, 12:19)]

# view data
head(district)</code></pre>
<pre><code>##   id        name          region population num_cities urban_ratio avg_salary
## 1  1 Hl.m. Praha          Prague    1204953          1       100.0      12541
## 2  2     Benesov central Bohemia      88884          5        46.7       8507
## 3  3      Beroun central Bohemia      75232          5        41.7       8980
## 4  4      Kladno central Bohemia     149893          6        67.4       9753
## 5  5       Kolin central Bohemia      95616          6        51.4       9307
## 6  6  Kutna Hora central Bohemia      77963          4        51.5       8546
##   entrepreneur_1000 municipality_0 municipality_500 municipality_2000
## 1               167              0                0                 0
## 2               132             80               26                 6
## 3               111             55               26                 4
## 4               109             63               29                 6
## 5               118             65               30                 4
## 6               126             60               23                 4
##   municipality_10000 unemployment_rate_95 unemployment_rate_96
## 1                  1                  0.2                 0.43
## 2                  2                  1.6                 1.85
## 3                  1                  1.9                 2.21
## 4                  2                  4.6                 5.05
## 5                  1                  3.8                 4.43
## 6                  2                  2.9                 4.02
##   commited_crimes_95 commited_crimes_96
## 1              85677              99107
## 2               2159               2674
## 3               2824               2813
## 4               5244               5892
## 5               2616               3040
## 6               2640               3120</code></pre>
<pre class="r"><code># save data
write.csv(district,&#39;district_r.csv&#39;)</code></pre>
</div>
<div id="district-python" class="section level1">
<h1>district (Python)</h1>
<pre class="python"><code>import pandas as pd
# load data
districts = pd.read_csv(&quot;./data/districts.csv&quot;)

# create new lists to store
# ready to split municipality_info
m_0 = []
m_500 = []
m_2000 = []
m_10000 = []
for index, row in districts.iterrows():
    x = row[&#39;municipality_info&#39;].split(&quot;,&quot;)
    m_0.append(int(x[0][1:]))
    m_500.append(int(x[1]))
    m_2000.append(int(x[2]))
    m_10000.append(int(x[3][:-1]))

# same as before
u_95 = []
u_96 = []
for index, row in districts.iterrows():
    y = row[&#39;unemployment_rate&#39;].split(&quot;,&quot;)
    u_95.append(y[0][1:])
    u_96.append(y[1][:-1])
# same as before
c_95 = []
c_96 = []
for index, row in districts.iterrows():
    z = row[&#39;commited_crimes&#39;].split(&quot;,&quot;)
    c_95.append(z[0][1:])
    c_96.append(z[1][:-1])

# create new columns to store term and status
districts[&#39;municipality_0&#39;] = m_0
districts[&#39;municipality_500&#39;] = m_500
districts[&#39;municipality_2000&#39;] = m_2000
districts[&#39;municipality_10000&#39;] = m_10000
districts[&#39;unemployment_rate_95&#39;] = u_95
districts[&#39;unemployment_rate_96&#39;] = u_96
districts[&#39;commited_crimes_95&#39;] = c_95
districts[&#39;commited_crimes_96&#39;] = c_96

# drop original columns
districts = districts.drop([&#39;municipality_info&#39;,&#39;unemployment_rate&#39;,&#39;commited_crimes&#39;], axis = 1)

# view data
print(districts.head())

# save data</code></pre>
<pre><code>##    id         name  ... commited_crimes_95  commited_crimes_96
## 0   1  Hl.m. Praha  ...              85677               99107
## 1   2      Benesov  ...               2159                2674
## 2   3       Beroun  ...               2824                2813
## 3   4       Kladno  ...               5244                5892
## 4   5        Kolin  ...               2616                3040
## 
## [5 rows x 16 columns]</code></pre>
<pre class="python"><code>districts.to_csv(&#39;district_py.csv&#39;, index = None)</code></pre>
</div>
<div id="customers-r" class="section level1">
<h1>customers (R)</h1>
<pre class="r"><code># read data
accounts &lt;- read.csv(file = &#39;data/accounts.csv&#39;)
districts &lt;- read.csv(file = &#39;district_py.csv&#39;)
links &lt;- read.csv(file = &#39;data/links.csv&#39;)
cards &lt;- read.csv(file = &#39;data/cards.csv&#39;)
loans &lt;- read.csv(file = &#39;loans_py.csv&#39;)
transactions &lt;- read.csv(file = &#39;data/transactions.csv&#39;)
# build the customers df based on accounts
df &lt;- accounts
head(df)</code></pre>
<pre><code>##   id district_id       date statement_frequency
## 1  1          18 1995-03-24             monthly
## 2  2           1 1993-02-26             monthly
## 3  3           5 1997-07-07             monthly
## 4  4          12 1996-02-21             monthly
## 5  5          15 1997-05-30             monthly
## 6  6          51 1994-09-27             monthly</code></pre>
<pre class="r"><code># account_id:
# the id from accounts dataset
df&lt;- rename(df, c(&quot;id&quot; = &quot;account_id&quot;))

# district_name:
# the name from districts
# account(district_id) = districts(id)
df$id &lt;- df$district_id
df &lt;- merge(df, districts, by = &#39;id&#39;)
# rename
df &lt;- rename(df, c(&quot;name&quot;=&quot;district_name&quot;))
# remove original columns
df &lt;- df[c(2:6)]

# open_date:
# the date from accounts
df &lt;- rename(df, c(&quot;date&quot; = &quot;open_date&quot;))

# state_frequency:
# the state_frequency from accounts

# num_customers is the total number of clients associated with the account from links dataset
cnt &lt;- count(links, vars = &quot;account_id&quot;)
df$num_customers &lt;- cnt$freq

# num_customers:
# the total number of clients in links
# account(account_id) = links(account_id)
links &lt;- rename(links, c(&quot;id&quot; = &quot;link_id&quot;))
links &lt;- merge(links, cards, by = &#39;link_id&#39;)
cnt2 &lt;- count(links, vars = &quot;account_id&quot;)

# credit_cards:
# the number of clients in links
# cards(link_id) = links(id); links(account_id) = account(credit_cards)
# create a credit_cards column with 0s
df &lt;- cbind(credit_cards = 0, df)
# replace 0 when the account_id appears in the links dataset with its number of cards
df$credit_cards[df$account_id %in% cnt2$account_id] &lt;- cnt2$freq

# loan:
# account_id in loans -&gt; T
# else F
ids = c()
for (id in df$account_id){
  if (id %in% loans$account_id){
    ids &lt;-c(ids, TRUE)
  }
  else{
    ids &lt;- c(ids, FALSE)
  }
}
df$loan &lt;- ids

# loan_amount, loan_payments, loan_term, loan_status are from loans dataset
df &lt;- merge(df, loans, by = &#39;account_id&#39;, all.x = TRUE)
df &lt;- rename(df, c(&quot;amount&quot; = &quot;loan_amount&quot;))
df &lt;- rename(df, c(&quot;payments&quot; = &quot;loan_payments&quot;))
df &lt;- rename(df, c(&quot;term&quot; = &quot;loan_term&quot;))
df &lt;- rename(df, c(&quot;status&quot; = &quot;loan_status&quot;))
df &lt;- df[-c(9:10)]

# loan_default:
# if loan status = B or D, True,
# if loan status if A or C,  False.
# NA if none.
status = c()
for (s in df$loan_status){
  if (!is.na(s)){
    if (s == &#39;B&#39; | s == &#39;D&#39;){
      status &lt;- c(status, TRUE)
    }
    else{
      status &lt;- c(status, FALSE)
    }
  }else{
    status &lt;- c(status,NA)
  }
}
df$loan_default &lt;- status

# max_withdrawal, min_withdrawal
# the amount from transactions dataset
# transactions(id) = account(account_id)
maxw &lt;- aggregate(x = transactions$amount, by = list(transactions$account_id), FUN = max)
maxw &lt;- rename(maxw, c(&quot;Group.1&quot; = &quot;account_id&quot;))
maxw &lt;- rename(maxw, c(&quot;x&quot; = &quot;max_withdrawal&quot;))
df &lt;- merge(df, maxw, by = &#39;account_id&#39;, all.x = TRUE)
minw &lt;- aggregate(x = transactions$amount, by = list(transactions$account_id), FUN = min)
minw &lt;- rename(minw, c(&quot;Group.1&quot; = &quot;account_id&quot;))
minw &lt;- rename(minw, c(&quot;x&quot; = &quot;min_withdrawal&quot;))
df &lt;- merge(df, minw, by = &#39;account_id&#39;, all.x = TRUE)

# cc_payments:
# count the credit payments of each account in transactions
transactions_credit &lt;- transactions[!transactions$type == &quot;debit&quot;, ]
cnt3 &lt;- count(transactions_credit, vars = &quot;account_id&quot;)

# merge
df &lt;- merge(df, cnt3, by = &#39;account_id&#39;, all.x = TRUE)
df &lt;- rename(df, c(&quot;freq&quot; = &quot;cc_payment&quot;))

# max_balance, min_balance
# the largest/smallest balance of each account in transactions
maxb &lt;- aggregate(x = transactions$balance, by = list(transactions$account_id), FUN = max)
maxb &lt;- rename(maxb, c(&quot;Group.1&quot; = &quot;account_id&quot;))
maxb &lt;- rename(maxb, c(&quot;x&quot; = &quot;max_balance&quot;))
df &lt;- merge(df, maxb, by = &#39;account_id&#39;, all.x = TRUE)
minb &lt;- aggregate(x = transactions$balance, by = list(transactions$account_id), FUN = min)
minb &lt;- rename(minb, c(&quot;Group.1&quot; = &quot;account_id&quot;))
minb &lt;- rename(minb, c(&quot;x&quot; = &quot;min_balance&quot;))
df &lt;- merge(df, minb, by = &#39;account_id&#39;, all.x = TRUE)

# remove district_id, which is not required
df &lt;- df[-c(3)]

#view dataset
head(df)</code></pre>
<pre><code>##   account_id credit_cards  open_date statement_frequency district_name
## 1          1            0 1995-03-24             monthly         Pisek
## 2          2            0 1993-02-26             monthly   Hl.m. Praha
## 3          3            0 1997-07-07             monthly         Kolin
## 4          4            0 1996-02-21             monthly       Pribram
## 5          5            0 1997-05-30             monthly Cesky Krumlov
## 6          6            0 1994-09-27             monthly       Trutnov
##   num_customers  loan loan_amount loan_payments loan_term loan_status
## 1             2 FALSE          NA            NA        NA        &lt;NA&gt;
## 2             2  TRUE       80952          3373        24           A
## 3             1 FALSE          NA            NA        NA        &lt;NA&gt;
## 4             2 FALSE          NA            NA        NA        &lt;NA&gt;
## 5             2 FALSE          NA            NA        NA        &lt;NA&gt;
## 6             1 FALSE          NA            NA        NA        &lt;NA&gt;
##   loan_default max_withdrawal min_withdrawal cc_payment max_balance min_balance
## 1           NA          12600             15        102       30415        1000
## 2        FALSE          42000             14        152       69302        1100
## 3           NA          11253             15         46       53447        1000
## 4           NA           5553             15         65       34870         800
## 5           NA           5100              4         35       32036         600
## 6           NA          11600             15         99       51879         900</code></pre>
<pre class="r"><code># save data
write_csv(df,&quot;customers_r.csv&quot;)</code></pre>
</div>
<div id="customers-python" class="section level1">
<h1>customers (Python)</h1>
<pre class="python"><code>import pandas as pd
import numpy as np

# load data
accounts = pd.read_csv(&quot;./data/accounts.csv&quot;)
districts = pd.read_csv(&quot;./district_py.csv&quot;)
links = pd.read_csv(&quot;./data/links.csv&quot;)
cards = pd.read_csv(&quot;./data/cards.csv&quot;)
loans = pd.read_csv(&quot;./loans_py.csv&quot;)
transactions = pd.read_csv(&quot;./data/transactions.csv&quot;)

# build the customers df based on accounts</code></pre>
<pre><code>## sys:1: DtypeWarning: Columns (6) have mixed types.Specify dtype option on import or set low_memory=False.</code></pre>
<pre class="python"><code>customers= accounts
print(customers.head())

# account_id:
# the id from accounts dataset</code></pre>
<pre><code>##    id  district_id        date statement_frequency
## 0   1           18  1995-03-24             monthly
## 1   2            1  1993-02-26             monthly
## 2   3            5  1997-07-07             monthly
## 3   4           12  1996-02-21             monthly
## 4   5           15  1997-05-30             monthly</code></pre>
<pre class="python"><code>customers.rename(columns={&#39;id&#39;: &#39;account_id&#39;}, inplace=True)

# district_name:
# the name from districts
# account(district_id) = districts(id)
customers[&#39;district_name&#39;] = customers[&#39;district_id&#39;].apply(lambda x: str(districts[districts[&#39;id&#39;] == x][&quot;name&quot;].values[0]))

# open_date:
# the date from accounts
customers.rename(columns={&#39;date&#39;: &#39;open_date&#39;}, inplace=True)

# state_frequency:
# the state_frequency from accounts

# num_customers:
# the total number of clients in links
# account(account_id) = links(account_id)
customers[&#39;num_customers&#39;] = customers[&#39;account_id&#39;].apply(lambda x: links[links[&quot;account_id&quot;] == x].shape[0])

# credit_cards:
# the number of clients in links
# cards(link_id) = links(id); links(account_id) = account(credit_cards)
links[&#39;credit_cards&#39;] = links[&#39;id&#39;].apply(lambda x: cards[cards[&#39;link_id&#39;] == x].shape[0])
customers[&#39;credit_cards&#39;] = customers[&#39;account_id&#39;].apply(lambda x: links[links[&#39;account_id&#39;] == x][&#39;credit_cards&#39;].values[0])

# loan:
# account_id in loans -&gt; T
# else F
customers[&#39;loan&#39;] = customers[&quot;account_id&quot;].apply(lambda x: loans[loans[&quot;account_id&quot;] == x].shape[0] != 0)

# left join loan and account_id
customers = pd.merge(customers, loans, how=&quot;left&quot;, on=[&quot;account_id&quot;])

# rename
customers.rename(columns={&quot;amount&quot;: &quot;loan_amount&quot;,  # loan_amount: the amount in loan dataset
                   &quot;payments&quot;: &quot;loan_payments&quot;,  # loan_payment: the payments in loan dataset
                   &quot;term&quot;: &quot;loan_term&quot;,  # loan_term: the term in loan dataset
                   &quot;status&quot;: &quot;loan_status&quot;},  # loan_status: the status in loan dataset
          inplace=True)

# loan_default:
# if loan status = B or D, True,
# if loan status if A or C,  False.
# NA if none.
status = []
for index, row in customers.iterrows():
    if pd.isna(row[&#39;loan_status&#39;]) == False:
        if row[&#39;loan_status&#39;] == &#39;B&#39; or row[&#39;loan_status&#39;] == &#39;D&#39;:
            status.append(&#39;True&#39;)
        else:
            status.append(&#39;False&#39;)
    else:
        status.append(np.nan)

# create 2 columns for term and status
customers[&#39;loan_default&#39;] = status

# max_withdrawal, min_withdrawal
# the amount from transactions dataset
# transactions(id) = account(account_id)
customers[&#39;max_withdrawal&#39;] = customers[&#39;account_id&#39;].apply(lambda x: np.max(transactions[transactions[&#39;account_id&#39;] == x][&#39;amount&#39;].values))
customers[&#39;min_withdrawal&#39;] = customers[&#39;account_id&#39;].apply(lambda x: np.min(transactions[transactions[&#39;account_id&#39;] == x][&#39;amount&#39;].values))

# cc_payments:
# count the credit payments of each account in transactions
ct = transactions[transactions[&#39;type&#39;] == &#39;Credit&#39;]
customers[&#39;cc_payments&#39;] = customers[&quot;account_id&quot;].apply(lambda x: ct[ct[&quot;account_id&quot;] == x].shape[0])

# max_balance, min_balance
# the largest/smallest balance of each account in transactions
customers[&#39;max_balance&#39;] = customers[&#39;account_id&#39;].apply(lambda x: np.max(transactions[transactions[&#39;account_id&#39;] == x][&#39;balance&#39;].values))
customers[&#39;min_balance&#39;] = customers[&#39;account_id&#39;].apply(lambda x: np.min(transactions[transactions[&#39;account_id&#39;] == x][&#39;balance&#39;].values))

# drop other columns
customers.drop([&quot;district_id&quot;, &quot;id&quot;, &quot;date&quot;], axis=1, inplace=True)

# view data
print(customers.head())

# save to csv</code></pre>
<pre><code>##    account_id   open_date  ... max_balance min_balance
## 0           1  1995-03-24  ...       30415        1000
## 1           2  1993-02-26  ...       69302        1100
## 2           3  1997-07-07  ...       53447        1000
## 3           4  1996-02-21  ...       34870         800
## 4           5  1997-05-30  ...       32036         600
## 
## [5 rows x 17 columns]</code></pre>
<pre class="python"><code>customers.to_csv(&quot;customers_py.csv&quot;, index=None)</code></pre>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
